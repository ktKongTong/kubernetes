name: build dra node image with cdi
on:
  workflow_dispatch:
    inputs:
      image:
        type: string
        description: 'Image name'
        default: 'node-cdi'
      tag:
        type: string
        description: 'Tag to build'
        default: 'latest'
#  push:
#    branches:
#      #      - master
#      # - release-1.26
  pull_request:
    branches:
      - master

# permissions:
#   contents: read

jobs:
  docker:
    name: build dra node image with cdi
    runs-on: ubuntu-20.04
    timeout-minutes: 30
    strategy:
      fail-fast: false
      matrix:
        docker_version: ["20.10"]
        docker_channel: ["stable"]
    env:
      JOB_NAME: "docker-${{ matrix.docker_version }}-${{ matrix.docker_channel }}"
      IMAGE_NAME: node-cdi
      IMAGE_TAG: latest
    #      IMAGE_NAME: ${{ github.event.inputs.image }}
    #      IMAGE_NAME: ${{ github.event.inputs.tag }}
    steps:
#      - name: checkout
#        uses: actions/checkout@v3
#        with:
#          ref: 'release-1.26'
      - name: Clone kubernetes repo
        run: |
          cd /home/runner/work/kubernetes
          git clone https://github.com/kubernetes/kubernetes
          pwd
          cd kubernetes
          pwd
          git switch release-1.26
      - name: Install Kind
        run: |
          curl -Lo ./kind "https://kind.sigs.k8s.io/dl/v0.17.0/kind-$(uname)-amd64"
          chmod +x ./kind
          sudo mv ./kind /usr/local/bin/kind
      - name: Build kind-dra-node-image
        run: |
          cd /home/runner/work/kubernetes/kubernetes
          chmod +x test/e2e/dra/kind-build-image.sh
          test/e2e/dra/kind-build-image.sh dra/node:latest
      - name: set lower case owner name
        run: |
          echo "OWNER_LC=${OWNER,,}" >>${GITHUB_ENV}
        env:
          OWNER: '${{ github.repository_owner }}'
      - name: Login to GitHub Container Registry
        uses: docker/login-action@v2
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}
      - name: push
        run: |
          docker tag dra/node:latest ghcr.io/${{ env.OWNER_LC }}/${{ env.IMAGE_NAME }}:${{ env.IMAGE_TAG }}
          docker push ghcr.io/${{ env.OWNER_LC }}/${{ env.IMAGE_NAME }}:${{ env.IMAGE_TAG }}